Pypicloud
=========

Runs a pypicloud_ server.

Configuration
-------------

The ``pypicloud/config.ini`` file includes various configuration options.  Most
importantly, you need to create at least one admin user with a password, in
order to upload new packages to your pypicloud.

Add at least one user name to the field ``auth.admins`` eg., ``admin``, and
then a password for this user as the field ``user.admin``.  By default, the
``admin`` user is created with a password set to *secret*.  If you want to set
it to a different keyword, use the tool ``ppc-gen-password`` after starting the
pypicloud container, it is available as

::

   sudo docker exec -it pypicloud /env/bin/python /env/bin/ppc-gen-password

You should also set the beaker keys to new values generated by

::

   python -c 'import os, base64; print base64.b64encode(os.urandom(32))'

For a secure connection with an SSL certificate, refer to the usage
instructions below.  Also consider step 4 and 5 of the usage instruction to
upload packages to the pypicloud.

For more information on the configuration options, including different storage
options for the eggs and wheels, refer to the `package documentation
<http://pypicloud.readthedocs.org/en/latest/topics/configuration.html>`_

Dependent images
----------------

The pypicloud_ server depends on the following images:

   - data/pypicloud
   - mdrohmann/pypicloud

They are built as follows:

::

   cd data/pypicloud
   sudo docker build --tag=data/pypicloud .

and

::

   cd services/pypicloud
   sudo docker build --tag mdrohmann/pypicloud .


Usage
-----

1. Create a storage container

   ::

      sudo docker create --name=pypi_data data/pypicloud

2. Run the gitolite container and bind it to the pypi_data data container.

   ::

     cd services/pypicloud
     sudo docker run --name pypicloud -v $PWD/pypicloud:/etc/pypicloud \
          -d -p 3031:3031 --volumes-from=data_pypi mdrohmann/pypicloud

3. Update your nginx configuration, by adding the following

   ::

      upstream docker-pypicloud {
        server localhost:3031;
      }

      server {
        server_name pypi-internal pypi-internal.main;
        listen 80;
        listen 443 ssl;

        ssl_certificate /etc/nginx/ssl/nginx.crt;
        ssl_certificate_key /etc/nginx/ssl/nginx.key;

        proxy_set_header Host    $http_host;
        proxy_set_header X-Real-IP $remote_addr;

        client_max_body_size 0;

        chunked_transfer_encoding on;

        location / {
          proxy_pass http://docker-pypicloud;
        }
      }

   The SSL certificate creation is described eg., in this
   `guide <https://devcenter.heroku.com/articles/ssl-certificate-self>`_.

   .. attention::

      Afterwards, the certificate file needs to be installed on the system:

       ::

         cp server.crt \
           /usr/local/share/ca-certificates/pypi-internal.crt
         update-ca-certificates

      See ``man update-ca-certificates`` for details.

4. Every client, that uses the pypi-server, should use pypi configurations from
   this directory:

   ::

      cp .pypirc ~/.pypirc
      cp .pip.conf ~/.pip/pip.conf

5. Upload packages with

   ::

      python setup.py sdist upload -r internal


There are
`alternatives for the pypicloud <https://wiki.python.org/moin/PyPiImplementations>`_.

.. _pypicloud: http://pypicloud.readthedocs.org/en/latest/
